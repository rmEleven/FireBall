class GameMenu{constructor(t){console.log("GameMenu Created"),this.root=t,this.$menu=$('\n            <div class="game-menu">\n                <div class="game-menu-field">\n                    <div class="game-menu-field-item game-menu-field-item-single-mode">\n                        单人模式\n                    </div>\n                    <div class="game-menu-field-item game-menu-field-item-multi-mode">\n                        多人模式\n                    </div>\n                    <div class="game-menu-field-item game-menu-field-item-settings">\n                        设置\n                    </div>\n                </div>\n            </div>\n        '),this.hide(),this.root.$game.append(this.$menu),this.$single_mode=this.$menu.find(".game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".game-menu-field-item-multi-mode"),this.$settings=this.$menu.find(".game-menu-field-item-settings"),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$single_mode.click((function(){console.log("single-mode clicked"),t.hide(),t.root.playground.show()})),this.$multi_mode.click((function(){console.log("multi-mode clicked")})),this.$settings.click((function(){console.log("settings clicked")}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}let last_timestamp,GAME_OBJECTS=[];class GameObject{constructor(){GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0}start(){}update(){}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<GAME_OBJECTS.length;t++)if(GAME_OBJECTS[t]===this){GAME_OBJECTS.splice(t,1);break}}}let GAME_ANIMATION=function(t){for(let i=0;i<GAME_OBJECTS.length;i++){let s=GAME_OBJECTS[i];s.has_called_start?(s.timedelta=t-last_timestamp,s.update()):(s.start(),s.has_called_start=!0)}last_timestamp=t,requestAnimationFrame(GAME_ANIMATION)};requestAnimationFrame(GAME_ANIMATION);class GameMap extends GameObject{constructor(t){console.log("GameMap Created"),super(),this.playground=t,this.$canvas=$("<canvas>画布</canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas),this.start()}start(){}update(){this.render()}render(){this.ctx.fillStyle="rgba(0,0,0,0.2)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}}class Player extends GameObject{constructor(t,i,s,e,h,a,n){console.log("Player Created"),super(),this.playground=t,this.ctx=this.playground.gameMap.ctx,this.x=i,this.y=s,this.radius=e,this.color=h,this.speed=a,this.move_length=0,this.vx=0,this.vy=0,this.d_speed=0,this.d_vx=0,this.d_vy=0,this.friction=.9,this.cur_skill=null,this.is_me=n,this.eps=.1}start(){if(this.is_me)this.add_listening_events();else{let t=Math.random()*this.playground.width,i=Math.random()*this.playground.height;this.move_to(t,i)}}add_listening_events(){let t=this;this.playground.gameMap.$canvas.on("contextmenu",(function(){return!1})),this.playground.gameMap.$canvas.mousedown((function(i){3===i.which?t.move_to(i.clientX,i.clientY):1===i.which&&("fireball"===t.cur_skill&&t.shoot_fireball(i.clientX,i.clientY),t.cur_skill=null)})),$(window).keydown((function(i){if(81===i.which)return t.cur_skill="fireball",!1}))}get_dist(t,i,s,e){let h=t-s,a=i-e;return Math.sqrt(h*h+a*a)}move_to(t,i){this.move_length=this.get_dist(this.x,this.y,t,i);let s=Math.atan2(i-this.y,t-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}shoot_fireball(t,i){let s=this.x,e=this.y,h=.01*this.playground.height,a=.5*this.playground.height,n=1*this.playground.height,l=Math.atan2(i-e,t-s),d=Math.cos(l),o=Math.sin(l),r=.01*this.playground.height;new FireBall(this.playground,this,s,e,h,"orange",a,n,d,o,r)}is_attacked(t,i){if(this.radius-=i,this.radius<this.eps)return this.destroy(),!1;this.d_speed=60*i,this.d_vx=Math.cos(t),this.d_vy=Math.sin(t),this.speed*=1.4}update(){if(this.d_speed>10){this.vx=this.vy=this.move_length=0;let t=this.d_speed*this.timedelta/1e3;this.x+=this.d_vx*t,this.y+=this.d_vy*t,this.d_speed*=this.friction}if(this.move_length<this.eps){if(this.move_length=0,this.vx=0,this.vy=0,!this.is_me){let t=Math.random()*this.playground.width,i=Math.random()*this.playground.height;this.move_to(t,i)}}else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}this.render()}render(){this.ctx.fillStyle=this.color,this.ctx.beginPath(),this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill()}}class FireBall extends GameObject{constructor(t,i,s,e,h,a,n,l,d,o,r){console.log("FireBall Created"),super(),this.playground=t,this.player=i,this.ctx=this.playground.gameMap.ctx,this.x=s,this.y=e,this.radius=h,this.color=a,this.speed=n,this.move_length=l,this.vx=d,this.vy=o,this.damage=r,this.eps=.1}start(){}get_dist(t,i,s,e){let h=t-s,a=i-e;return Math.sqrt(h*h+a*a)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}attack(t){let i=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(i,this.damage),this.destroy()}update(){if(this.move_length<this.eps)this.destroy();else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];i!==this.player&&this.is_collision(i)&&this.attack(i)}this.render()}render(){this.ctx.fillStyle=this.color,this.ctx.beginPath(),this.ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),this.ctx.fill()}}class GamePlayground{constructor(t){console.log("GamePlayground Created"),this.root=t,this.$playground=$('\n            <div class="game-playground">\n            </div>\n        '),this.root.$game.append(this.$playground),this.width=this.$playground.width(),this.height=this.$playground.height(),this.gameMap=new GameMap(this),this.players=[],this.players.push(new Player(this,this.width/2,this.height/2,.05*this.height,"rgb(83,131,236)",.15*this.height,!0));let i=["lightcoral","lightgray","lightgreen","lightsalmon","lightyellow"];for(let t=0;t<5;t++){let t=Math.random()*this.width,s=Math.random()*this.height,e=Math.floor(Math.random()*i.length);this.players.push(new Player(this,t,s,.05*this.height,i[e],.15*this.height,!1))}this.start()}start(){this.add_listening_events()}add_listening_events(){}show(){this.$playground.show()}hide(){this.$playground.hide()}}export class Game{constructor(t){console.log("Game Created"),this.id=t,this.$game=$("#"+t),this.menu=new GameMenu(this),this.playground=new GamePlayground(this),this.start()}start(){}}
